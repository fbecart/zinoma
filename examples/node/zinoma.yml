targets:
    backend_install_node_dependencies:
        input_paths: [docker-test/backend/package.json, docker-test/backend/yarn.lock]
        output_paths: [docker-test/backend/node_modules]
        build: |
            cd docker-test/backend
            yarn install

    backend_run:
        dependencies: [backend_install_node_dependencies]
        input_paths: [docker-test/backend]
        service: |
            cd docker-test/backend
            exec node index.js

    backend_docker_build:
        input_paths: [docker-test/backend]
        build: |
            cd docker-test/backend
            docker build -t todos/backend .

    webapp_install_node_dependencies:
        input_paths: [docker-test/webapp/package.json, docker-test/webapp/yarn.lock]
        output_paths: [docker-test/webapp/node_modules]
        build: |
            cd docker-test/webapp
            yarn install

    webapp_build:
        dependencies: [webapp_install_node_dependencies]
        input_paths: [docker-test/webapp]
        output_paths: [docker-test/webapp/build]
        build: |
            cd docker-test/webapp
            yarn build

    webapp_run:
        dependencies: [webapp_install_node_dependencies]
        input_paths: [docker-test/webapp]
        service: |
            cd docker-test/webapp
            exec yarn start
    
    webapp_docker_build:
        dependencies: [webapp_build]
        input_paths: [docker-test/webapp/Dockerfile, docker-test/webapp/build]
        build: |
            cd docker-test/webapp
            docker build -t todos/webapp .

    full_stack_run:
        dependencies: [backend_run, webapp_run]

    full_stack_docker_run:
        dependencies: [backend_docker_build, webapp_docker_build]
        service: |
            cd docker-test
            exec docker-compose up
    
    e2e_install_node_dependencies:
        input_paths: [docker-test/e2e/package.json, docker-test/e2e/yarn.lock]
        output_paths: [docker-test/e2e/node_modules]
        build: |
            cd docker-test/e2e
            yarn install
    
    e2e_run:
        dependencies: [e2e_install_node_dependencies]
        build: |
            cd docker-test/e2e
            yarn start

    e2e_docker_build:
        input_paths: [docker-test/e2e]
        build: |
            cd docker-test/e2e
            docker build -t todos/e2e .
    
    e2e_docker_run:
        dependencies: [backend_docker_build, webapp_docker_build, e2e_docker_build]
        input_paths:
            - docker-test/docker-compose.e2e.yml
            - docker-test/docker-compose.yml
            - docker-test/backend
            - docker-test/webapp
            - docker-test/e2e
        output_paths: [docker-test/target]
        build: |
            cd docker-test
            docker-compose -f docker-compose.yml -f docker-compose.e2e.yml up --exit-code-from todos-e2e
